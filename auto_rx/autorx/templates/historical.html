<!DOCTYPE html>
<html>
<head>
    <title>Radiosonde Auto-RX Historical</title>

    <!-- Configure to work on mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Import style sheets (font and icons are remote, should fix) -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/roboto.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/c3.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/leaflet.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/leaflet.fullscreen.css') }}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" >
    <link id='tabulatorsheet' href="{{ url_for('static', filename='css/tabulator_midnight.min.css') }}" rel='stylesheet'>
    
    <!-- Import local libraries -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <script src="{{ url_for('static', filename='js/leaflet-providers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/Leaflet.fullscreen.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/leaflet.edgebuffer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/scan_chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/c3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/d3.min.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/autorxapi.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabulator.min.js') }}"></script>
    
    <script>
        var autorx_config = {
            lat: 0.0,
            lon: 0.0
        };

        var table_data = {}
            
        $( document ).ready(function() {

            namespace = '/update_status';

            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);
            
            $.ajax({
                  // Get station.cfg file.
                  url: "/get_config",
                  dataType: 'json',
                  async: false,
                  success: function(data) {
                    autorx_config = data;
                    // Update station callsign area
                    _station_call = autorx_config['habitat_uploader_callsign'];
                    $('#station_callsign').text(_station_call);
                  }
            });  
            
            $.ajax({
                  // Get list of sonde.
                  url: "/get_log_list",
                  dataType: 'json',
                  async: false,
                  success: function(data) {
                    table_data = data;
                  }
            });   

            var table = new Tabulator("#sonde-list-table", {
                data:table_data,           //load row data from array
                layout:"fitColumns",     //fit columns to width of table
                selectable:true,
                columns:[                 //define the table columns
                    {title:"Type", field:"type", width:190, resizable:false},
                    {title:"Serial", field:"serial", width:105, resizable:false},
                    {title:"Date", field:"datetime", width:205, resizable:false, formatter:function(cell, formatterParams, onRendered){
                        if (getCookie('UTC') == 'false') {
                            var temp_time = new Date(cell.getValue());
                            if (temp_time.toLocaleString("en-AU") == "Invalid Date") {                    
                                return;
                            } else {
                                return temp_time.toLocaleString("en-AU");
                            }                            
                        } else {
                            return cell.getValue();
                        }
                    }
                    }
                ]
            });

            //select row on "select all" button click
            $("#select-all").click(function(){
                table.selectRow();
            });

            //deselect row on "deselect all" button click
            $("#deselect-all").click(function(){
                table.deselectRow();
            });

            $("#showsonde-map").click(function(){
                selectedrows = table.getSelectedData();
                if (selectedrows.length > 0) {
                    var i;
                    for (i = 0; i < selectedrows.length; i++) {
                        console.log(selectedrows[i]['serial']);
                        $.ajax({
                            url: "/get_log_by_serial/" + selectedrows[i]['serial'],
                            dataType: 'json',
                            async: false,
                            success: function(data) {
                                console.log(data);
                            }
                        });  
                    }
                }
            });

            $("#showsonde-skew").click(function(){
                //console.log(table.getSelectedData());
            });
            
            // List of available map layers.
            var Mapnik = L.tileLayer.provider("OpenStreetMap.Mapnik", {edgeBufferTiles: 2});
            var DarkMatter = L.tileLayer.provider("CartoDB.DarkMatter", {edgeBufferTiles: 2});
            var Terrain = L.tileLayer.provider("Stamen.Terrain", {edgeBufferTiles: 2});
            var WorldImagery = L.tileLayer.provider("Esri.WorldImagery", {edgeBufferTiles: 2});
            var Voyager = L.tileLayer.provider("CartoDB.Voyager", {edgeBufferTiles: 2});
            var OpenTopoMap = L.tileLayer.provider("OpenTopoMap", {edgeBufferTiles: 2});
            
            // Add maps to baseMaps.
            var baseMaps = {
                "Mapnik": Mapnik,
                "DarkMatter": DarkMatter,
                "WorldImagery": WorldImagery,
                "Terrain": Terrain,
                "Voyager": Voyager,
                "OpenTopoMap": OpenTopoMap                          
            };

            // Check if user has preffered map theme.
            var x = getCookie('theme');
            if (x) {
                mapTheme = x;
            } else {
                if (getCookie('dark') == "false") {
                    mapTheme = "Mapnik"
                } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    mapTheme = "DarkMatter"
                } else {
                    mapTheme = "Mapnik"
                }
            }
            
            // Home Icon.
            homeIcon = L.icon({
            iconUrl: '{{ url_for('static', filename='img/antenna-green.png') }}',
            iconSize: [26, 34],
            iconAnchor: [13, 34]
            });  
            
            // Home Icon for dark mode.
            homeIconDark = L.icon({
            iconUrl: '{{ url_for('static', filename='img/antenna-green-dark.png') }}',
            iconSize: [26, 34],
            iconAnchor: [13, 34]
            });  
            
            // Create map object.
            mymap = L.map('mapid').setView([autorx_config.station_lat, autorx_config.station_lon], 8);
            mymap.addControl(new L.Control.Fullscreen());
            if (mapTheme != 'DarkMatter' && mapTheme != 'WorldImagery') {
                home_marker = L.marker([autorx_config.station_lat, autorx_config.station_lon, autorx_config.alt],
                        {title: 'Receiver Location', icon: homeIcon}
                        ).addTo(mymap);
            } else {
                home_marker = L.marker([autorx_config.station_lat, autorx_config.station_lon, autorx_config.alt],
                        {title: 'Receiver Location', icon: homeIconDark}
                        ).addTo(mymap);
            }
                       
            L.control.layers(baseMaps).addTo(mymap);

            baseMaps[mapTheme].addTo(mymap);
            
            // Update preffered them cookie on layer change.
            mymap.on('baselayerchange', function(e) {
                setCookie("theme", e['name'], 365);
                if(e['name'] == "DarkMatter" || e['name'] == "WorldImagery"){
                    home_marker.setIcon(homeIconDark);
                 }else{
                    home_marker.setIcon(homeIcon);
                 }
            });
            
            // Check if user has dark mode set.
            if (getCookie('dark') == 'true') {
                changeTheme(true);
            } else if (getCookie('dark') == 'false') {
                changeTheme(false);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                changeTheme(true);
            } else {
                changeTheme(false);
            }              
               
            // Function to change CSS options when changing dark mode.
            function changeTheme(dark) {
                if (dark == false) {
                    document.body.style.background = 'white';
                    if (document.getElementById("log-tray").style.color == "rgb(255, 0, 0)") {
                        $('#main span').css('color', 'black')
                        $('#log-tray').css('color', 'red');
                    } else {
                        $('#main span').css('color', 'black')
                    }
                    $('#main p').css('color', 'black')
                    $('.modal-content p').css('color', 'black')
                    $('.modal-content h2').css('color', 'black')
                    $('.modal-content span').css('color', 'black')
                    $('.modal-content').css('background-color', 'white')
                    $('.close').css('color', 'black')
                    $('#myBtn').css('color', 'black')
                    $('#scanid').css('color', 'black')
                    $('.c3-axis-y').css('fill', 'black')
                    $('.c3-axis-x').css('fill', 'black')
                    $('.c3-legend-item text').css('fill', 'black')
                    $('.domain').css('stroke', 'black')
                    $('.tick line').css('stroke', 'black')  
                    $('#mapid span').css('color', 'black') 
                    $('.sidenav').css('background-color', '#111')
                    $('.settings').css('background-color', '#111')  
                } else {
                    document.body.style.background = '#121212';
                    if (document.getElementById("log-tray").style.color == "rgb(255, 0, 0)") {
                        $('#main span').css('color', 'white')
                        $('#log-tray').css('color', 'red');
                    } else {
                        $('#main span').css('color', 'white')
                    }
                    $('#main p').css('color', 'white')
                    $('.modal-content p').css('color', 'white')
                    $('.modal-content h2').css('color', 'white')
                    $('.modal-content span').css('color', 'white')
                    $('.modal-content').css('background-color', 'black')
                    $('.close').css('color', 'white')
                    $('#myBtn').css('color', 'white')
                    $('#scanid').css('color', 'white')
                    $('.c3-axis-y').css('fill', 'white')
                    $('.c3-axis-x').css('fill', 'white')
                    $('.c3-legend-item text').css('fill', 'white')
                    $('.domain').css('stroke', 'white')
                    $('.tick line').css('stroke', 'white')
                    $('#mapid span').css('color', 'black')
                    $('.sidenav').css('background-color', '#414141')
                    $('.settings').css('background-color', '#414141')
                }
            }

            // Invalidate map size to fix problems with elements resizing.
            mymap.invalidateSize(); 

            socket.on('station_update', function(msg) {
                // Station update messages indicate a move of the station location, as updated
                // by a GPS receiver.

                if(initial_load_complete == false){
                    // If we have not completed our initial load of telemetry data, discard this data.
                    return
                }

                // Update the marker position.
                home_marker.setLatLng([msg.lat, msg.lon, msg.alt]).update();

                // Update the autorx_config object, which is used to calculate relative look angles for the telemetry table.
                autorx_config.station_lat = msg.lat;
                autorx_config.station_lon = msg.lon;
                autorx_config.station_alt = msg.alt;

            });
        });

        // Function to open/close left log menu along with adjusting other elements so they render correctly.
        function changeNav() {
            var x = document.getElementById("closebtn");
            var y = document.getElementById('mapid');
            if (document.getElementById("mySidenav").style.width == "0px" || document.getElementById("mySidenav").style.width == 0) {
                if ((window.innerWidth/window.innerHeight) > 1) { // 500px wide on desktop.
                    x.style.display = "none";
                    y.style.display = "block";
                    document.getElementById("mySidenav").style.width = "500px";
                    document.getElementById("main").style.marginLeft = "500px";
                    document.getElementById("mySidenav").style.borderRadius = "0px 25px 25px 0px";  
                    mymap.invalidateSize();
                } else { // Fullsize on mobile.
                    x.style.display = "block";
                    y.style.display = "none";
                    document.getElementById("mySidenav").style.width = "100%";
                    document.getElementById("main").style.marginLeft = "0";
                    document.getElementById("mySidenav").style.borderRadius = "0px";
                }
            } else {
                x.style.display = "none";
                y.style.display = "block";
                document.getElementById("mySidenav").style.width = 0;
                document.getElementById("main").style.marginLeft = 0;
                mymap.invalidateSize();
            }
        }

        // Function to open/close right settings menu along with adjusting other elements so they render correctly.
        function changeSettings() {            
            var y = document.getElementById('mapid');
            if (document.getElementById("mySettings").style.width == "0px" || document.getElementById("mySettings").style.width == 0) {
                if ((window.innerWidth/window.innerHeight) > 1) { // 350px wide on desktop.
                    y.style.display = "block";
                    document.getElementById("mySettings").style.width = "350px";
                    document.getElementById("main").style.marginRight = "350px";
                    document.getElementById("mySettings").style.borderRadius = "25px 0px 0px 25px";
                    mymap.invalidateSize();
                } else { // Fullsize on mobile.
                    y.style.display = "none";
                    document.getElementById("mySettings").style.width = "100%";
                    document.getElementById("main").style.marginRight = "0";
                    document.getElementById("mySettings").style.borderRadius = "0px";
                }
            } else {
                y.style.display = "block";
                document.getElementById("mySettings").style.width = 0;
                document.getElementById("main").style.marginRight = 0;
                mymap.invalidateSize();
            }
        }

        // Set given cookie name and value.
        function setCookie(name,value) {
            localStorage.setItem(name, value);
        }

        // Return cookie value given name.
        function getCookie(name) {
            return localStorage.getItem(name);
        }

        // Reset specific cookie.
        function eraseCookie(name) {   
            localStorage.removeItem(name);
        }

        // Reset all cookies.
        function deleteAllCookies() {
            localStorage.clear();
            location.reload();
        }
        
        let vh = window.innerHeight * 0.01;
        
        document.documentElement.style.setProperty('--vh', `${vh}px`);        
    </script>
</head>
<body>
    <!-- Wrapper for entire body to ensure flex works -->    
    <div class="wrapper">
        <!-- Wrapper for sonde list sidebar -->   
        <div id="mySidenav" class="sidenav">
            <div class="headerdiv">
            <a href="javascript:void(0)" class="closebtn" id="closebtn" onclick="changeNav()">&#10006;</a>
            <img src="{{ url_for('static', filename='img/autorx_logo.png') }}" alt="Radiosonde Auto-RX Button">
            <h2>Sonde List</h2>
            <div style="width:100%;text-align:center;">
                <button id="select-all" style="margin:0 auto">Select All</button>
                <button id="deselect-all" style="margin:0 auto">Deselect All</button>
                <button id="showsonde-map" style="margin:0 auto">Map</button>
                <button id="showsonde-skew" style="margin:0 auto">Skew-T</button>
            </div>
            <br>
            </div>
            <div id="sonde-list-table"></div>       
        </div>

    <!-- Wrapper for settings sidebar -->   
    <div id="mySettings" class="settings">
        <a href="javascript:void(0)" class="closebtn2" id="closebtn2" onclick="changeSettings()">&#10006;</a>
        <br><h2>Skew Plot</h2>
    </div>

    <!-- Wrapper for main screen -->   
    <div id="main" onload="loadMap();">
        <div>
            <span style="font-size:3vh;font-size:calc(var(--vh, 1vh) * 3);cursor:pointer;" onclick="changeNav()"><span id="log-tray">&#9776;</span> Radiosonde Auto-RX Historical</span>
        </div>
        <span style="font-size:2vh;font-size:calc(var(--vh, 1vh) * 2);" id="footertext"></span>
        <br>
        <div id="mapid"></div>
        <i id="myBtn" onclick="changeSettings()" class="fa fa-gear" style="font-size:4vh;font-size:calc(var(--vh, 1vh) * 4);"></i>
    </div>
</div>
</body>
</html>

